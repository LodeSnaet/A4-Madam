{% set baseUrl = craft.app.request.getPathInfo() %}
{% set allParams = craft.app.request.getQueryParams() %}
{% set key = dropdown.title|kebab %}

{# Set whether multiple filters are allowed based on handle #}
{% if key in [ 'colour', 'condition', 'material',  'style'] %}
  {% set multipleFiltersAllowed = true %}
{% else %}
  {% set multipleFiltersAllowed = false %}
{% endif %}

{% set selected = (allParams[key] ?? '')|split(',')|filter(v => v != '') %}

<div class="c-dropdown js-dropdown">
  <p class="c-dropdown__title js-dropdown-btn">{{ dropdown.title }}</p>

  <ul class="c-dropdown__filters">
    {% for filter in dropdown.filters %}
      {% set val = filter.title|kebab %}
      {% set isActive = val in selected %}

      {# Handle single vs multiple selection #}
      {% if multipleFiltersAllowed %}
        {% set newSelected = isActive ? selected|filter(v => v != val) : selected|merge([val]) %}
      {% else %}
        {% set newSelected = isActive ? [] : [val] %}
      {% endif %}

      {# Copy all other params except the current key #}
      {% set newParams = {} %}
      {% for groupKey, groupVal in allParams %}
        {% if groupKey != key and groupVal is not empty %}
          {% set newParams = newParams | merge({ (groupKey): groupVal }) %}
        {% endif %}
      {% endfor %}

      {# Add the key only if newSelected has values #}
      {% if newSelected is not empty %}
        {% set newParams = newParams | merge({ (key): newSelected|join(',') }) %}
      {% endif %}

      {% set link = url(baseUrl, newParams) %}

      <li class="{{ isActive ? 'is-active' }}">
        <a href="{{ link }}" class="c-dropdown__filter{{ isActive ? ' c-dropdown__filter--active' }}">
          {{ filter.title }}
        </a>
      </li>
    {% endfor %}
  </ul>
</div>
